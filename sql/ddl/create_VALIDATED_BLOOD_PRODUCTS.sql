-- =============================================================================
-- create_VALIDATED_BLOOD_PRODUCTS.sql
-- =============================================================================
-- Purpose:      Create validated.blood_products table for harmonized
--               cross-source data.
--
-- Schema:       validated
-- Grain:        One row per source record mapped into this domain
-- Columns:      354 (5 governance + 349 domain)
-- Sources:      CISIR, TRAUMA_REGISTRY
--
-- Dependencies: validated schema must exist
--               governance.batch_log must exist (FK target for ingest_id)
--
-- Generated by: r/build_tools/generate_validated_ddls.R
-- Author:       Noel
-- Last Updated: 2026-02-04
-- =============================================================================

CREATE TABLE IF NOT EXISTS validated.blood_products (
    -- Governance columns
    validated_id            SERIAL PRIMARY KEY,
    source_type             TEXT NOT NULL,
    source_table            TEXT NOT NULL,
    ingest_id               TEXT NOT NULL,
    created_at              TIMESTAMPTZ NOT NULL DEFAULT NOW(),

    -- Domain columns
    account_number          TEXT,
    cat                     BOOLEAN,
    cisir_id                TEXT,
    cryo_0                  INTEGER,
    cryo_1                  INTEGER,
    cryo_10                 INTEGER,
    cryo_11                 INTEGER,
    cryo_12                 INTEGER,
    cryo_13                 INTEGER,
    cryo_14                 INTEGER,
    cryo_15                 INTEGER,
    cryo_16                 INTEGER,
    cryo_17                 INTEGER,
    cryo_18                 INTEGER,
    cryo_19                 INTEGER,
    cryo_2                  INTEGER,
    cryo_20                 INTEGER,
    cryo_21                 INTEGER,
    cryo_22                 INTEGER,
    cryo_23                 INTEGER,
    cryo_24                 INTEGER,
    cryo_25                 INTEGER,
    cryo_26                 INTEGER,
    cryo_27                 INTEGER,
    cryo_28                 INTEGER,
    cryo_29                 INTEGER,
    cryo_3                  INTEGER,
    cryo_30                 INTEGER,
    cryo_31                 INTEGER,
    cryo_32                 INTEGER,
    cryo_33                 INTEGER,
    cryo_34                 INTEGER,
    cryo_35                 INTEGER,
    cryo_36                 INTEGER,
    cryo_37                 INTEGER,
    cryo_38                 INTEGER,
    cryo_39                 INTEGER,
    cryo_4                  INTEGER,
    cryo_40                 INTEGER,
    cryo_41                 INTEGER,
    cryo_42                 INTEGER,
    cryo_43                 INTEGER,
    cryo_44                 INTEGER,
    cryo_45                 INTEGER,
    cryo_46                 INTEGER,
    cryo_47                 INTEGER,
    cryo_48                 INTEGER,
    cryo_5                  INTEGER,
    cryo_6                  INTEGER,
    cryo_7                  INTEGER,
    cryo_8                  INTEGER,
    cryo_9                  INTEGER,
    ff_0                    INTEGER,
    ff_1                    INTEGER,
    ff_10                   INTEGER,
    ff_11                   INTEGER,
    ff_12                   INTEGER,
    ff_13                   INTEGER,
    ff_14                   INTEGER,
    ff_15                   INTEGER,
    ff_16                   INTEGER,
    ff_17                   INTEGER,
    ff_18                   INTEGER,
    ff_19                   INTEGER,
    ff_2                    INTEGER,
    ff_20                   INTEGER,
    ff_21                   INTEGER,
    ff_22                   INTEGER,
    ff_23                   INTEGER,
    ff_24                   INTEGER,
    ff_25                   INTEGER,
    ff_26                   INTEGER,
    ff_27                   INTEGER,
    ff_28                   INTEGER,
    ff_29                   INTEGER,
    ff_3                    INTEGER,
    ff_30                   INTEGER,
    ff_31                   INTEGER,
    ff_32                   INTEGER,
    ff_33                   INTEGER,
    ff_34                   INTEGER,
    ff_35                   INTEGER,
    ff_36                   INTEGER,
    ff_37                   INTEGER,
    ff_38                   INTEGER,
    ff_39                   INTEGER,
    ff_4                    INTEGER,
    ff_40                   INTEGER,
    ff_41                   INTEGER,
    ff_42                   INTEGER,
    ff_43                   INTEGER,
    ff_44                   INTEGER,
    ff_45                   INTEGER,
    ff_46                   INTEGER,
    ff_47                   INTEGER,
    ff_48                   INTEGER,
    ff_5                    INTEGER,
    ff_6                    INTEGER,
    ff_7                    INTEGER,
    ff_8                    INTEGER,
    ff_9                    INTEGER,
    ffp_0                   INTEGER,
    ffp_1                   INTEGER,
    ffp_10                  INTEGER,
    ffp_11                  INTEGER,
    ffp_12                  INTEGER,
    ffp_13                  INTEGER,
    ffp_14                  INTEGER,
    ffp_15                  INTEGER,
    ffp_16                  INTEGER,
    ffp_17                  INTEGER,
    ffp_18                  INTEGER,
    ffp_19                  INTEGER,
    ffp_2                   INTEGER,
    ffp_20                  INTEGER,
    ffp_21                  INTEGER,
    ffp_22                  INTEGER,
    ffp_23                  INTEGER,
    ffp_24                  INTEGER,
    ffp_25                  INTEGER,
    ffp_26                  INTEGER,
    ffp_27                  INTEGER,
    ffp_28                  INTEGER,
    ffp_29                  INTEGER,
    ffp_3                   INTEGER,
    ffp_30                  INTEGER,
    ffp_31                  INTEGER,
    ffp_32                  INTEGER,
    ffp_33                  INTEGER,
    ffp_34                  INTEGER,
    ffp_35                  INTEGER,
    ffp_36                  INTEGER,
    ffp_37                  INTEGER,
    ffp_38                  INTEGER,
    ffp_39                  INTEGER,
    ffp_4                   INTEGER,
    ffp_40                  INTEGER,
    ffp_41                  INTEGER,
    ffp_42                  INTEGER,
    ffp_43                  INTEGER,
    ffp_44                  INTEGER,
    ffp_45                  INTEGER,
    ffp_46                  INTEGER,
    ffp_47                  INTEGER,
    ffp_48                  INTEGER,
    ffp_5                   INTEGER,
    ffp_6                   INTEGER,
    ffp_7                   INTEGER,
    ffp_8                   INTEGER,
    ffp_9                   INTEGER,
    mrn                     TEXT,
    mtp                     BOOLEAN,
    plat_0                  INTEGER,
    plat_1                  INTEGER,
    plat_10                 INTEGER,
    plat_11                 INTEGER,
    plat_12                 INTEGER,
    plat_13                 INTEGER,
    plat_14                 INTEGER,
    plat_15                 INTEGER,
    plat_16                 INTEGER,
    plat_17                 INTEGER,
    plat_18                 INTEGER,
    plat_19                 INTEGER,
    plat_2                  INTEGER,
    plat_20                 INTEGER,
    plat_21                 INTEGER,
    plat_22                 INTEGER,
    plat_23                 INTEGER,
    plat_24                 INTEGER,
    plat_25                 INTEGER,
    plat_26                 INTEGER,
    plat_27                 INTEGER,
    plat_28                 INTEGER,
    plat_29                 INTEGER,
    plat_3                  INTEGER,
    plat_30                 INTEGER,
    plat_31                 INTEGER,
    plat_32                 INTEGER,
    plat_33                 INTEGER,
    plat_34                 INTEGER,
    plat_35                 INTEGER,
    plat_36                 INTEGER,
    plat_37                 INTEGER,
    plat_38                 INTEGER,
    plat_39                 INTEGER,
    plat_4                  INTEGER,
    plat_40                 INTEGER,
    plat_41                 INTEGER,
    plat_42                 INTEGER,
    plat_43                 INTEGER,
    plat_44                 INTEGER,
    plat_45                 INTEGER,
    plat_46                 INTEGER,
    plat_47                 INTEGER,
    plat_48                 INTEGER,
    plat_5                  INTEGER,
    plat_6                  INTEGER,
    plat_7                  INTEGER,
    plat_8                  INTEGER,
    plat_9                  INTEGER,
    prbc_0                  INTEGER,
    prbc_1                  INTEGER,
    prbc_10                 INTEGER,
    prbc_11                 INTEGER,
    prbc_12                 INTEGER,
    prbc_13                 INTEGER,
    prbc_14                 INTEGER,
    prbc_15                 INTEGER,
    prbc_16                 INTEGER,
    prbc_17                 INTEGER,
    prbc_18                 INTEGER,
    prbc_19                 INTEGER,
    prbc_2                  INTEGER,
    prbc_20                 INTEGER,
    prbc_21                 INTEGER,
    prbc_22                 INTEGER,
    prbc_23                 INTEGER,
    prbc_24                 INTEGER,
    prbc_25                 INTEGER,
    prbc_26                 INTEGER,
    prbc_27                 INTEGER,
    prbc_28                 INTEGER,
    prbc_29                 INTEGER,
    prbc_3                  INTEGER,
    prbc_30                 INTEGER,
    prbc_31                 INTEGER,
    prbc_32                 INTEGER,
    prbc_33                 INTEGER,
    prbc_34                 INTEGER,
    prbc_35                 INTEGER,
    prbc_36                 INTEGER,
    prbc_37                 INTEGER,
    prbc_38                 INTEGER,
    prbc_39                 INTEGER,
    prbc_4                  INTEGER,
    prbc_40                 INTEGER,
    prbc_41                 INTEGER,
    prbc_42                 INTEGER,
    prbc_43                 INTEGER,
    prbc_44                 INTEGER,
    prbc_45                 INTEGER,
    prbc_46                 INTEGER,
    prbc_47                 INTEGER,
    prbc_48                 INTEGER,
    prbc_5                  INTEGER,
    prbc_6                  INTEGER,
    prbc_7                  INTEGER,
    prbc_8                  INTEGER,
    prbc_9                  INTEGER,
    rbc_0                   INTEGER,
    rbc_1                   INTEGER,
    rbc_10                  INTEGER,
    rbc_11                  INTEGER,
    rbc_12                  INTEGER,
    rbc_13                  INTEGER,
    rbc_14                  INTEGER,
    rbc_15                  INTEGER,
    rbc_16                  INTEGER,
    rbc_17                  INTEGER,
    rbc_18                  INTEGER,
    rbc_19                  INTEGER,
    rbc_2                   INTEGER,
    rbc_20                  INTEGER,
    rbc_21                  INTEGER,
    rbc_22                  INTEGER,
    rbc_23                  INTEGER,
    rbc_24                  INTEGER,
    rbc_25                  INTEGER,
    rbc_26                  INTEGER,
    rbc_27                  INTEGER,
    rbc_28                  INTEGER,
    rbc_29                  INTEGER,
    rbc_3                   INTEGER,
    rbc_30                  INTEGER,
    rbc_31                  INTEGER,
    rbc_32                  INTEGER,
    rbc_33                  INTEGER,
    rbc_34                  INTEGER,
    rbc_35                  INTEGER,
    rbc_36                  INTEGER,
    rbc_37                  INTEGER,
    rbc_38                  INTEGER,
    rbc_39                  INTEGER,
    rbc_4                   INTEGER,
    rbc_40                  INTEGER,
    rbc_41                  INTEGER,
    rbc_42                  INTEGER,
    rbc_43                  INTEGER,
    rbc_44                  INTEGER,
    rbc_45                  INTEGER,
    rbc_46                  INTEGER,
    rbc_47                  INTEGER,
    rbc_48                  INTEGER,
    rbc_5                   INTEGER,
    rbc_6                   INTEGER,
    rbc_7                   INTEGER,
    rbc_8                   INTEGER,
    rbc_9                   INTEGER,
    trauma_number           TEXT,
    wb_0                    INTEGER,
    wb_1                    INTEGER,
    wb_10                   INTEGER,
    wb_11                   INTEGER,
    wb_12                   INTEGER,
    wb_13                   INTEGER,
    wb_14                   INTEGER,
    wb_15                   INTEGER,
    wb_16                   INTEGER,
    wb_17                   INTEGER,
    wb_18                   INTEGER,
    wb_19                   INTEGER,
    wb_2                    INTEGER,
    wb_20                   INTEGER,
    wb_21                   INTEGER,
    wb_22                   INTEGER,
    wb_23                   INTEGER,
    wb_24                   INTEGER,
    wb_25                   INTEGER,
    wb_26                   INTEGER,
    wb_27                   INTEGER,
    wb_28                   INTEGER,
    wb_29                   INTEGER,
    wb_3                    INTEGER,
    wb_30                   INTEGER,
    wb_31                   INTEGER,
    wb_32                   INTEGER,
    wb_33                   INTEGER,
    wb_34                   INTEGER,
    wb_35                   INTEGER,
    wb_36                   INTEGER,
    wb_37                   INTEGER,
    wb_38                   INTEGER,
    wb_39                   INTEGER,
    wb_4                    INTEGER,
    wb_40                   INTEGER,
    wb_41                   INTEGER,
    wb_42                   INTEGER,
    wb_43                   INTEGER,
    wb_44                   INTEGER,
    wb_45                   INTEGER,
    wb_46                   INTEGER,
    wb_47                   INTEGER,
    wb_48                   INTEGER,
    wb_5                    INTEGER,
    wb_6                    INTEGER,
    wb_7                    INTEGER,
    wb_8                    INTEGER,
    wb_9                    INTEGER

    -- Foreign key to batch lineage
    ,CONSTRAINT fk_blood_products_ingest
        FOREIGN KEY (ingest_id)
        REFERENCES governance.batch_log (ingest_id)
        ON DELETE CASCADE
);

-- =============================================================================
-- INDEXES
-- =============================================================================

CREATE INDEX IF NOT EXISTS idx_blood_products_source_type
    ON validated.blood_products (source_type);

CREATE INDEX IF NOT EXISTS idx_blood_products_ingest_id
    ON validated.blood_products (ingest_id);

CREATE INDEX IF NOT EXISTS idx_blood_products_account_number
    ON validated.blood_products (account_number);

CREATE INDEX IF NOT EXISTS idx_blood_products_mrn
    ON validated.blood_products (mrn);

CREATE INDEX IF NOT EXISTS idx_blood_products_trauma_number
    ON validated.blood_products (trauma_number);

CREATE INDEX IF NOT EXISTS idx_blood_products_cisir_id
    ON validated.blood_products (cisir_id);

-- =============================================================================
-- COMMENTS
-- =============================================================================

COMMENT ON TABLE validated.blood_products IS
'Harmonized blood products data combined from: CISIR, TRAUMA_REGISTRY. Populated by Step 6 harmonization.';

COMMENT ON COLUMN validated.blood_products.source_type IS
'Origin data source: CISIR, CLARITY, or TRAUMA_REGISTRY.';

COMMENT ON COLUMN validated.blood_products.source_table IS
'Staging table this row was sourced from.';

COMMENT ON COLUMN validated.blood_products.ingest_id IS
'Batch identifier linking to governance.batch_log for lineage.';

COMMENT ON COLUMN validated.blood_products.created_at IS
'Timestamp when this row was inserted into the validated table.';

