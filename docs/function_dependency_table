# PULSE Function Dependency Table

| Name                        | Type       | Purpose                                                                                                  | File Path                              | Depends On                                                                                                  | Called By                                                                                          |
|-----------------------------|------------|----------------------------------------------------------------------------------------------------------|----------------------------------------|-------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------|
| `connect_to_pulse()`        | R function | Open a Postgres connection using env vars (`PULSE_DB`, `PULSE_HOST`, `PULSE_USER`, `PULSE_PW`).         | `r/connect_to_pulse.R`                 | `DBI`, `RPostgres` (or equivalent), environment variables                                                   | `pulse-init-all.R`, `run_pipeline()`, `1_onboard_new_source.R`, `2_ingest_and_log_files.R`, tests |
| `load_pipeline_settings()`  | R function | Load global pipeline settings and controlled vocab from YAML.                                           | `r/runner.R`                           | `yaml`, `getOption("pulse.proj_root")`                                                                      | `run_pipeline()`, `validate_source_entry()`, `register_source()`, tests                           |
| `qualify_table()`           | R function | Helper to build schema-qualified `DBI::Id` objects.                                                      | `r/runner.R`                           | `DBI`                                                                                                        | `get_pipeline_steps()`, other DB helpers                                                          |
| `get_pipeline_steps()`      | R function | Read `governance.pipeline_step`, filter to enabled steps, order by `step_order`.                        | `r/runner.R`                           | `DBI`, `dplyr`, `qualify_table()`, `load_pipeline_settings()`                                               | `run_pipeline()`                                                                                   |
| `execute_step()`            | R function | Dispatch a pipeline step (SQL / R / RMD). Special-case `STEP_001`.                                      | `r/runner.R`                           | `DBI`, `glue`, `rmarkdown`, `load_source_params()`, `run_step1_register_source()`                          | `run_pipeline()`                                                                                   |
| `run_pipeline()`            | R function | Core orchestrator: connect to DB, load settings, fetch steps, loop through them via `execute_step()`.   | `r/runner.R`                           | `connect_to_pulse()`, `load_pipeline_settings()`, `get_pipeline_steps()`, `execute_step()`                  | `pulse-launch.R`, tests                                                                           |
| `load_source_params()`      | R function | Read `config/source_params.yml` and return as a list.                                                    | `r/utilities/load_source_params.R`     | `yaml`, `getOption("pulse.proj_root")`                                                                      | `run_step1_register_source()`, `execute_step()` (for `STEP_001`), tests                           |
| `validate_source_entry()`   | R function | Validate a candidate source definition against required fields + vocabularies.                           | `r/utilities/validate_source_entry.R`  | `load_pipeline_settings()`, `stopifnot`, `dplyr`                                                            | `register_source()`, tests                                                                        |
| `create_source_folders()`   | R function | Build on-disk folder tree for a source using `directory_structure.yml`.                                 | `r/utilities/create_source_folders.R`  | `yaml`, `fs`, `getOption("pulse.proj_root")`                                                                | `register_source()`, tests                                                                        |
| `write_audit_event()`       | R function | Insert a single governed event row into `governance.audit_log`.                                         | `r/steps/write_audit_event.R`          | `DBI`, `glue`, `jsonlite`, `uuid`                                                                          | `register_source()`, future steps (e.g., QC, releases), tests                                     |
| `write_pipeline_step()`     | R function | Record a step definition or execution metadata into `governance.pipeline_step`.                         | `r/utilities/write_pipeline_step.R`    | `DBI`, `glue`, `jsonlite`                                                                                   | `run_step1_register_source()`, migration/seed scripts, tests                                      |
| `register_source()`         | R function | Core Step 1 engine: validate source, insert/update `source_registry`, create folders, audit log event.   | `r/steps/register_source.R`            | `DBI`, `validate_source_entry()`, `create_source_folders()`, `write_audit_event()`, `load_pipeline_settings()` | `run_step1_register_source()`, tests                                                              |
| `run_step1_register_source()` | R function | Step 1 wrapper; calls `register_source()` and logs step definition via `write_pipeline_step()`.         | `r/steps/run_step1_register_source.R`  | `register_source()`, `write_pipeline_step()`, `load_source_params()`                                       | `execute_step()` for `STEP_001`, `pulse_launch()`, tests                                          |
| `pulse_launch()`            | R function | High-level entry point for a pipeline run; optionally writes `source_params.yml`, calls `run_pipeline()`. | `pulse-launch.R`                       | `yaml`, `run_pipeline()`, `load_pipeline_settings()`                                                        | `1_onboard_new_source.R`, tests                                                                   |
| `1_onboard_new_source.R`    | Script     | Human-friendly Step 1 entry: initialize, define `ingest_id` + `source_params`, call `pulse_launch()`.   | `r/scripts/1_onboard_new_source.R`     | `pulse-init-all.R`, `pulse-launch.R`                                                                       | Human users, onboarding docs                                                                      |
| `get_ingest_dict()`         | R function | Load `reference.ingest_dictionary` and normalize column names to lower case.                             | `r/steps/ingest.R`                     | `DBI`, `DBI::Id`, `dplyr`                                                                                   | `ingest_one_file()`, tests                                                                       |
| `ingest_one_file()`         | R function | **Strict type-enforced single-file ingestion into `raw.<lake_table>`** with harmonization + metadata.   | `r/steps/ingest.R`                     | `get_ingest_dict()`, `vroom`, `dplyr`, `digest`, `DBI::dbWriteTable`, `stringr`                             | `ingest_batch()`, direct testing                                                                 |
| `log_batch_ingest()`        | R function | Step 2A: create a `batch_log` row and add `pending` rows to `ingest_file_log` per file.                  | `r/steps/log_batch_ingest.R`           | `DBI`, `glue`, `fs`, `readr`, `dplyr`                                                                      | `2_ingest_and_log_files.R`, tests                                                                |
| `ingest_batch()`            | R function | Step 2B: loop over pending files, call `ingest_one_file()`, update `ingest_file_log` + `batch_log`.      | `r/steps/log_batch_ingest.R`           | `DBI`, `glue`, `dplyr`, `ingest_one_file()`                                                                 | `2_ingest_and_log_files.R`, tests                                                                |
| `2_ingest_and_log_files.R`  | Script     | Human-friendly Step 2 entry: derive `ingest_id`, list CSVs, call `log_batch_ingest()` and `ingest_batch()`. | `r/scripts/2_ingest_and_log_files.R` | `pulse-init-all.R`, `connect_to_pulse()`, `log_batch_ingest()`, `ingest_batch()`, `fs`, `glue`              | Human users, docs                                                                                 |
| `pulse-init-all.R`          | Script     | Initialization: set options, source core files, ensure schemas/tables exist.                            | `pulse-init-all.R`                     | `connect_to_pulse()`, DDL SQL files, seeding scripts                                                       | `1_onboard_new_source.R`, `2_ingest_and_log_files.R`, tests                                      |
| `create_BATCH_LOG.sql`      | SQL DDL    | Create `governance.batch_log` (ingest-level summary/log).                                               | `sql/ddl/create_BATCH_LOG.sql`         | Postgres                                                                                                    | `pulse-init-all.R`, migrations                                                                   |
| `create_INGEST_FILE_LOG.sql`| SQL DDL    | Create `governance.ingest_file_log` (file-level lineage).                                               | `sql/ddl/create_INGEST_FILE_LOG.sql`   | Postgres                                                                                                    | `pulse-init-all.R`, migrations                                                                   |
| `create_SOURCE_REGISTRY.sql`| SQL DDL    | Create `governance.source_registry`.                                                                   | `sql/ddl/create_SOURCE_REGISTRY.sql`   | Postgres                                                                                                    | `pulse-init-all.R`, migrations                                                                   |
| `create_AUDIT_LOG.sql`      | SQL DDL    | Create `governance.audit_log`.                                                                          | `sql/ddl/create_AUDIT_LOG.sql`         | Postgres                                                                                                    | `pulse-init-all.R`, migrations                                                                   |
| `create_PIPELINE_STEP.sql`  | SQL DDL    | Create `governance.pipeline_step`.                                                                      | `sql/ddl/create_PIPELINE_STEP.sql`     | Postgres                                                                                                    | `pulse-init-all.R`, migrations                                                                   |
| `insert_PIPELINE_STEP_step1.sql` | SQL seed | Seed `STEP_001` definition into `pipeline_step`.                                                        | `sql/inserts/insert_PIPELINE_STEP_step1.sql` | Postgres                                                                                          | `pulse-init-all.R`, migrations                                                                   |
| `insert_PIPELINE_STEP_step2.sql` | SQL seed | Seed `STEP_002` (if/when used in full-run mode).                                                        | `sql/inserts/insert_PIPELINE_STEP_step2.sql` | Postgres                                                                                          | `pulse-init-all.R`, migrations                                                                   |
| `pipeline_settings.yml`     | YAML       | Central controlled vocab + schema references.                                                            | `config/pipeline_settings.yml`         | YAML parser                                                                                               | `validate_source_entry()`, `register_source()`, `load_pipeline_settings()`, docs                 |
| `source_params.yml`         | YAML       | Per-source config used by Step 1.                                                                       | `config/source_params.yml`             | YAML parser                                                                                               | `load_source_params()`, `run_step1_register_source()`                                            |
| `directory_structure.yml`   | YAML       | Directory template for `create_source_folders()`.                                                       | `directory_structure.yml`              | YAML parser                                                                                               | `create_source_folders()`, docs                                                                  |
| `test_step1_register_source.R` | Test   | Unit tests for Step 1 (validation + DB + audit).                                                        | `tests/testthat/test_step1_register_source.R` | `testthat`, Step 1 functions                                                                      | `devtools::test()`                                                                               |
| `test_step1_integration.R`  | Test       | End-to-end test: `pulse_launch()` + `run_pipeline()` for Step 1.                                        | `tests/testthat/test_step1_integration.R` | `testthat`, Step 1 functions, `pulse-init-all.R`                                                 | `devtools::test()`                                                                               |
| `test_step2_batch_logging.R`| Test       | Unit tests for `log_batch_ingest()`, `ingest_batch()`, and `ingest_one_file()`.                         | `tests/testthat/test_step2_batch_logging.R` | `testthat`, Step 2 functions, `ingest_dictionary`, temp files                                    | `devtools::test()`                                                                               |
