# PULSE Function Dependency Table

| Name                        | Type       | Purpose                                                                                                  | File Path                              | Depends On                                                                                                  | Called By                                                                                          |
|-----------------------------|------------|----------------------------------------------------------------------------------------------------------|----------------------------------------|-------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------|
| `connect_to_pulse()`        | R function | Open a Postgres connection using env vars (`PULSE_DB`, `PULSE_HOST`, `PULSE_USER`, `PULSE_PW`).         | `r/connect_to_pulse.R`                 | `DBI`, `RPostgres` (or equivalent), environment variables                                                   | `pulse-init-all.R`, `run_pipeline()`, `1_onboard_new_source.R`, `2_ingest_and_log_files.R`, tests |
| `load_pipeline_settings()`  | R function | Load global pipeline settings and controlled vocab from YAML.                                           | `r/runner.R`                           | `yaml`, `getOption("pulse.proj_root")`                                                                      | `run_pipeline()`, `validate_source_entry()`, `register_source()`, tests                           |
| `qualify_table()`           | R function | Helper to build schema-qualified `DBI::Id` objects.                                                      | `r/runner.R`                           | `DBI`                                                                                                        | `get_pipeline_steps()`, other DB helpers                                                          |
| `get_pipeline_steps()`      | R function | Read `governance.pipeline_step`, filter to enabled steps, order by `step_order`.                        | `r/runner.R`                           | `DBI`, `dplyr`, `qualify_table()`, `load_pipeline_settings()`                                               | `run_pipeline()`                                                                                   |
| `execute_step()`            | R function | Dispatch a pipeline step (SQL / R / RMD). Special-case `STEP_001`.                                      | `r/runner.R`                           | `DBI`, `glue`, `rmarkdown`, `load_source_params()`, `run_step1_register_source()`                          | `run_pipeline()`                                                                                   |
| `run_pipeline()`            | R function | Core orchestrator: connect to DB, load settings, fetch steps, loop through them via `execute_step()`.   | `r/runner.R`                           | `connect_to_pulse()`, `load_pipeline_settings()`, `get_pipeline_steps()`, `execute_step()`                  | `pulse-launch.R`, tests                                                                           |
| `load_source_params()`      | R function | Read `config/source_params.yml` and return as a list.                                                    | `r/utilities/load_source_params.R`     | `yaml`, `getOption("pulse.proj_root")`                                                                      | `run_step1_register_source()`, `execute_step()` (for `STEP_001`), tests                           |
| `validate_source_entry()`   | R function | Validate a candidate source definition against required fields + vocabularies.                           | `r/utilities/validate_source_entry.R`  | `load_pipeline_settings()`, `stopifnot`, `dplyr`                                                            | `register_source()`, tests                                                                        |
| `create_source_folders()`   | R function | Build on-disk folder tree for a source using `directory_structure.yml`.                                 | `r/utilities/create_source_folders.R`  | `yaml`, `fs`, `getOption("pulse.proj_root")`                                                                | `register_source()`, tests                                                                        |
| `write_audit_event()`       | R function | Insert a single governed event row into `governance.audit_log`.                                         | `r/steps/write_audit_event.R`          | `DBI`, `glue`, `jsonlite`, `uuid`                                                                          | `register_source()`, future steps (e.g., QC, releases), tests                                     |
| `write_pipeline_step()`     | R function | Record a step definition or execution metadata into `governance.pipeline_step`.                         | `r/utilities/write_pipeline_step.R`    | `DBI`, `glue`, `jsonlite`                                                                                   | `run_step1_register_source()`, migration/seed scripts, tests                                      |
| `register_source()`         | R function | Core Step 1 engine: validate source, insert/update `source_registry`, create folders, audit log event.   | `r/steps/register_source.R`            | `DBI`, `validate_source_entry()`, `create_source_folders()`, `write_audit_event()`, `load_pipeline_settings()` | `run_step1_register_source()`, tests                                                              |
| `run_step1_register_source()` | R function | Step 1 wrapper; calls `register_source()` and logs step definition via `write_pipeline_step()`.         | `r/steps/run_step1_register_source.R`  | `register_source()`, `write_pipeline_step()`, `load_source_params()`                                       | `execute_step()` for `STEP_001`, `pulse_launch()`, tests                                          |
| `pulse_launch()`            | R function | High-level entry point for a pipeline run; optionally writes `source_params.yml`, calls `run_pipeline()`. | `pulse-launch.R`                       | `yaml`, `run_pipeline()`, `load_pipeline_settings()`                                                        | `1_onboard_new_source.R`, tests                                                                   |
| `1_onboard_new_source.R`    | Script     | Human-friendly Step 1 entry: initialize, define `ingest_id` + `source_params`, call `pulse_launch()`.   | `r/scripts/1_onboard_new_source.R`     | `pulse-init-all.R`, `pulse-launch.R`                                                                       | Human users, onboarding docs                                                                      |
| `get_ingest_dict()`         | R function | Load `reference.ingest_dictionary` and normalize column names to lower case.                             | `r/steps/ingest.R`                     | `DBI`, `DBI::Id`, `dplyr`                                                                                   | `ingest_one_file()`, tests                                                                       |
| `ingest_one_file()`         | R function | **Strict type-enforced single-file ingestion into `raw.<lake_table>`** with harmonization + metadata.   | `r/steps/ingest.R`                     | `get_ingest_dict()`, `vroom`, `dplyr`, `digest`, `DBI::dbWriteTable`, `stringr`                             | `ingest_batch()`, direct testing                                                                 |
| `log_batch_ingest()`        | R function | Step 2A: create a `batch_log` row and add `pending` rows to `ingest_file_log` per file.                  | `r/steps/log_batch_ingest.R`           | `DBI`, `glue`, `fs`, `readr`, `dplyr`                                                                      | `2_ingest_and_log_files.R`, tests                                                                |
| `ingest_batch()`            | R function | Step 2B: loop over pending files, call `ingest_one_file()`, update `ingest_file_log` + `batch_log`.      | `r/steps/log_batch_ingest.R`           | `DBI`, `glue`, `dplyr`, `ingest_one_file()`                                                                 | `2_ingest_and_log_files.R`, tests                                                                |
| `2_ingest_and_log_files.R`  | Script     | Human-friendly Step 2 entry: derive `ingest_id`, list CSVs, call `log_batch_ingest()` and `ingest_batch()`. | `r/scripts/2_ingest_and_log_files.R` | `pulse-init-all.R`, `connect_to_pulse()`, `log_batch_ingest()`, `ingest_batch()`, `fs`, `glue`              | Human users, docs                                                                                 |
| `pulse-init-all.R`          | Script     | Initialization: set options, source core files, ensure schemas/tables exist.                            | `pulse-init-all.R`                     | `connect_to_pulse()`, DDL SQL files, seeding scripts                                                       | `1_onboard_new_source.R`, `2_ingest_and_log_files.R`, tests                                      |
| `create_BATCH_LOG.sql`      | SQL DDL    | Create `governance.batch_log` (ingest-level summary/log).                                               | `sql/ddl/create_BATCH_LOG.sql`         | Postgres                                                                                                    | `pulse-init-all.R`, migrations                                                                   |
| `create_INGEST_FILE_LOG.sql`| SQL DDL    | Create `governance.ingest_file_log` (file-level lineage).                                               | `sql/ddl/create_INGEST_FILE_LOG.sql`   | Postgres                                                                                                    | `pulse-init-all.R`, migrations                                                                   |
| `create_SOURCE_REGISTRY.sql`| SQL DDL    | Create `governance.source_registry`.                                                                   | `sql/ddl/create_SOURCE_REGISTRY.sql`   | Postgres                                                                                                    | `pulse-init-all.R`, migrations                                                                   |
| `create_AUDIT_LOG.sql`      | SQL DDL    | Create `governance.audit_log`.                                                                          | `sql/ddl/create_AUDIT_LOG.sql`         | Postgres                                                                                                    | `pulse-init-all.R`, migrations                                                                   |
| `create_PIPELINE_STEP.sql`  | SQL DDL    | Create `governance.pipeline_step`.                                                                      | `sql/ddl/create_PIPELINE_STEP.sql`     | Postgres                                                                                                    | `pulse-init-all.R`, migrations                                                                   |
| `insert_PIPELINE_STEP_step1.sql` | SQL seed | Seed `STEP_001` definition into `pipeline_step`.                                                        | `sql/inserts/insert_PIPELINE_STEP_step1.sql` | Postgres                                                                                          | `pulse-init-all.R`, migrations                                                                   |
| `insert_PIPELINE_STEP_step2.sql` | SQL seed | Seed `STEP_002` (if/when used in full-run mode).                                                        | `sql/inserts/insert_PIPELINE_STEP_step2.sql` | Postgres                                                                                          | `pulse-init-all.R`, migrations                                                                   |
| `pipeline_settings.yml`     | YAML       | Central controlled vocab + schema references.                                                            | `config/pipeline_settings.yml`         | YAML parser                                                                                               | `validate_source_entry()`, `register_source()`, `load_pipeline_settings()`, docs                 |
| `source_params.yml`         | YAML       | Per-source runtime config written by `pulse_launch()` during Step 1 (not tracked in git).               | `config/source_params.yml`             | YAML parser                                                                                               | `load_source_params()`, `run_step1_register_source()`                                            |
| `directory_structure.yml`   | YAML       | Directory template for `create_source_folders()`.                                                       | `directory_structure.yml`              | YAML parser                                                                                               | `create_source_folders()`, docs                                                                  |
| `test_step1_register_source.R` | Test   | Unit tests for Step 1 (validation + DB + audit).                                                        | `tests/testthat/test_step1_register_source.R` | `testthat`, Step 1 functions                                                                      | `devtools::test()`                                                                               |
| `test_step1_integration.R`  | Test       | End-to-end test: `pulse_launch()` + `run_pipeline()` for Step 1.                                        | `tests/testthat/test_step1_integration.R` | `testthat`, Step 1 functions, `pulse-init-all.R`                                                 | `devtools::test()`                                                                               |
| `test_step2_batch_logging.R`| Test       | Unit tests for `log_batch_ingest()`, `ingest_batch()`, and `ingest_one_file()`.                         | `tests/testthat/test_step2_batch_logging.R` | `testthat`, Step 2 functions, `ingest_dictionary`, temp files                                    | `devtools::test()`                                                                               |
| `compare_fields()`          | R function | Compare expected vs observed schema for a single table; detect missing, extra, and mismatched columns.  | `r/utilities/compare_fields.R`         | `dplyr`, `tibble`                                                                                           | `validate_schema()`, tests                                                                       |
| `validate_schema()`         | R function | Step 3 orchestrator: load expected schema, compare all raw tables, write issues to `structure_qc_table`. | `r/steps/validate_schema.R`            | `DBI`, `dplyr`, `compare_fields()`, `reference.metadata`, `governance.ingest_file_log`                      | `3_validate_schema.R`, tests                                                                     |
| `sync_metadata()`           | R function | Synchronize core metadata dictionary from Excel into `reference.metadata` with version tracking and field-level audit trail. | `r/reference/sync_metadata.R` | `DBI`, `dplyr`, `glue`, `tibble`, `load_metadata_dictionary()`, `compare_metadata()`, `write_audit_event()` | `4_sync_metadata.R`, `3_validate_schema.R` (optional pre-sync), tests                            |
| `load_metadata_dictionary()`| R function | Load `CURRENT_core_metadata_dictionary.xlsx`, validate required columns, standardize Y/N to boolean, check for duplicate keys. | `r/reference/load_metadata_dictionary.R` | `readxl`, `dplyr`, `glue`, `tibble`                                                                   | `sync_metadata()`, tests                                                                         |
| `compare_metadata()`        | R function | Compare new dictionary (from Excel) to current database state; return field-level diff (INITIAL/ADD/UPDATE/REMOVE). | `r/utilities/compare_metadata.R` | `dplyr`, `tidyr`, `tibble`, `glue`                                                                         | `sync_metadata()`, tests                                                                         |
| `get_current_metadata_version()` | R function | Return the current (maximum) `version_number` from `reference.metadata`; returns 0 if empty. | `r/reference/get_current_metadata_version.R` | `DBI`                                                                                                | `sync_metadata()`, manual use, tests                                                             |
| `3_validate_schema.R`       | Script     | Human-friendly Step 3 entry: set `ingest_id`, call `validate_schema()`, print summary.                  | `r/scripts/3_validate_schema.R`        | `pulse-init-all.R`, `connect_to_pulse()`, `validate_schema()`                                               | Human users, docs                                                                                |
| `4_sync_metadata.R`         | Script     | Human-friendly Step 4 entry: set `dict_path`, call `sync_metadata()`, print version/change summary.     | `r/scripts/4_sync_metadata.R`          | `pulse-init-all.R`, `connect_to_pulse()`, `sync_metadata()`                                                 | Human users, docs                                                                                |
| `test_step3_schema_validation.R` | Test  | Unit + integration tests for `compare_fields()` and `validate_schema()`.                                 | `tests/testthat/test_step3_schema_validation.R` | `testthat`, Step 3 functions, `reference.metadata`                                              | `devtools::test()`                                                                               |
| `test_step4_metadata_sync.R` | Test      | Unit tests for `load_metadata_dictionary()`, `compare_metadata()`, and `sync_metadata()`.               | `tests/testthat/test_step4_metadata_sync.R` | `testthat`, Step 4 functions, `CURRENT_core_metadata_dictionary.xlsx`                                | `devtools::test()`                                                                               |
| `create_STRUCTURE_QC_TABLE.sql`  | SQL DDL | Create `governance.structure_qc_table` (schema validation issue log).                                   | `sql/ddl/create_STRUCTURE_QC_TABLE.sql` | Postgres                                                                                                   | `pulse-init-all.R`, migrations                                                                   |
| `recreate_METADATA_v2.sql`  | SQL DDL    | Recreate `reference.metadata` as dictionary-only table with version tracking and composite PK.           | `sql/ddl/recreate_METADATA_v2.sql`     | Postgres                                                                                                   | `pulse-init-all.R`, migrations                                                                   |
| `create_METADATA_HISTORY.sql` | SQL DDL  | Create `reference.metadata_history` for field-level change audit trail.                                  | `sql/ddl/create_METADATA_HISTORY.sql`  | Postgres                                                                                                   | `pulse-init-all.R`, migrations                                                                   |
| `profile_data()`              | R function | Step 5 orchestrator: load config, verify ingest, profile each table, write to 5 governance tables, compute overall score, log audit event. | `r/steps/profile_data.R` | `DBI`, `dplyr`, `glue`, `tibble`, `load_profiling_config()`, `profile_table()`, `write_audit_event()` | `5_profile_data.R`, tests |
| `profile_table()`             | R function | Profile all columns of a single table. Calls leaf functions, aggregates into 5 tibbles. NO database writes. | `r/profiling/profile_table.R` | `DBI`, `dplyr`, `tibble`, `glue`, `infer_column_type()`, `detect_sentinels()`, `profile_missingness()`, `profile_distribution()`, `generate_issues()`, `calculate_quality_score()` | `profile_data()`, tests |
| `detect_sentinels()`          | R function | Detect sentinel/placeholder values using config-based matching (high) and frequency analysis (medium).    | `r/profiling/detect_sentinels.R`       | `dplyr`, `tibble`                                                                                          | `profile_table()`, tests                                                                         |
| `profile_missingness()`       | R function | Classify each value into exactly one of 5 mutually exclusive categories: NA, empty, whitespace, sentinel, valid. | `r/profiling/profile_missingness.R` | Base R only                                                                                                | `profile_table()`, tests                                                                         |
| `profile_distribution()`      | R function | Compute distribution stats: numeric (min/max/mean/median/sd/quartiles) or categorical (top-N JSON, mode). | `r/profiling/profile_distribution.R`   | `jsonlite`                                                                                                 | `profile_table()`, tests                                                                         |
| `generate_issues()`           | R function | Flag quality issues: identifier_missing, high_missingness, moderate_missingness, constant_value, high_cardinality. | `r/profiling/generate_issues.R`  | `tibble`, `glue`, `dplyr`                                                                                  | `profile_table()`, tests                                                                         |
| `calculate_quality_score()`   | R function | Rate table quality as Excellent/Good/Fair/Needs Review based on max missing pct and critical issue count. | `r/profiling/calculate_quality_score.R` | Base R only                                                                                                | `profile_table()`, tests                                                                         |
| `load_profiling_config()`     | R function | Load profiling config from YAML with hardcoded defaults. Works even if YAML file is missing.              | `r/utilities/load_profiling_config.R`  | `yaml`                                                                                                     | `profile_data()`, tests                                                                          |
| `infer_column_type()`         | R function | Classify TEXT column as identifier/numeric/date/categorical by name patterns and value parsing.            | `r/utilities/infer_column_type.R`      | Base R only                                                                                                | `profile_table()`, tests                                                                         |
| `5_profile_data.R`            | Script     | Human-friendly Step 5 entry: set `ingest_id` and schema, call `profile_data()`, print quality summary.    | `r/scripts/5_profile_data.R`           | `pulse-init-all.R`, `connect_to_pulse()`, `profile_data()`                                                 | Human users, docs                                                                                |
| `test_step5_data_profiling.R` | Test       | Unit + integration tests for all profiling functions and `profile_data()` orchestrator.                    | `tests/testthat/test_step5_data_profiling.R` | `testthat`, Step 5 functions, DB connection                                                          | `devtools::test()`                                                                               |
| `profiling_settings.yml`      | YAML       | Profiling thresholds, sentinel lists, identifier patterns, display settings.                               | `config/profiling_settings.yml`        | YAML parser                                                                                                | `load_profiling_config()`, `profile_data()`, docs                                                |
| `create_DATA_PROFILE.sql`     | SQL DDL    | Create `governance.data_profile` (variable-level missingness).                                            | `sql/ddl/create_DATA_PROFILE.sql`      | Postgres                                                                                                   | `pulse-init-all.R`, migrations                                                                   |
| `create_DATA_PROFILE_DISTRIBUTION.sql` | SQL DDL | Create `governance.data_profile_distribution` (numeric/categorical stats).                          | `sql/ddl/create_DATA_PROFILE_DISTRIBUTION.sql` | Postgres                                                                                             | `pulse-init-all.R`, migrations                                                                   |
| `create_DATA_PROFILE_SENTINEL.sql` | SQL DDL | Create `governance.data_profile_sentinel` (detected placeholder values).                                  | `sql/ddl/create_DATA_PROFILE_SENTINEL.sql` | Postgres                                                                                               | `pulse-init-all.R`, migrations                                                                   |
| `create_DATA_PROFILE_ISSUE.sql` | SQL DDL  | Create `governance.data_profile_issue` (quality issues flagged).                                          | `sql/ddl/create_DATA_PROFILE_ISSUE.sql` | Postgres                                                                                                  | `pulse-init-all.R`, migrations                                                                   |
| `create_DATA_PROFILE_SUMMARY.sql` | SQL DDL | Create `governance.data_profile_summary` (per-table quality scores).                                      | `sql/ddl/create_DATA_PROFILE_SUMMARY.sql` | Postgres                                                                                               | `pulse-init-all.R`, migrations                                                                   |
| **Review Scripts** | | | | | |
| `review_step1_sources.R`     | Script     | View all registered data sources.                                                                          | `r/review/review_step1_sources.R`      | `DBI`, `glue`                                                                                              | Human users                                                                                      |
| `review_step2_ingestion.R`   | Script     | Batch overview and file-level ingestion detail, filterable by source.                                      | `r/review/review_step2_ingestion.R`    | `DBI`, `glue`                                                                                              | Human users                                                                                      |
| `review_step3_validation.R`  | Script     | Schema validation issues by table and severity with optional table drill-down.                             | `r/review/review_step3_validation.R`   | `DBI`, `glue`                                                                                              | Human users                                                                                      |
| `review_step4_metadata.R`    | Script     | Metadata state, version history, variable counts by source type and table.                                 | `r/review/review_step4_metadata.R`     | `DBI`, `glue`                                                                                              | Human users                                                                                      |
| `review_step5_profiling.R`   | Script     | Quality scores, issues, missingness, sentinels, distributions with table drill-down.                       | `r/review/review_step5_profiling.R`    | `DBI`, `glue`                                                                                              | Human users                                                                                      |
| `review_audit_trail.R`       | Script     | Cross-step audit log with optional ingest filtering.                                                       | `r/review/review_audit_trail.R`        | `DBI`, `glue`                                                                                              | Human users                                                                                      |
