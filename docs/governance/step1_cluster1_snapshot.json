{
  "version": "step1_cluster1_snapshot_v1",
  "description": "PULSE pipeline Step 1 × Cluster 1 (Source Registration) — code + structure snapshot.",
  "schemas": {
    "governance": "governance",
    "raw": "raw",
    "staging": "staging",
    "validated": "validated",
    "reference": "reference"
  },
  "db_objects": {
    "tables": [
      {
        "name": "governance.source_registry",
        "purpose": "Canonical registry of data sources and governance metadata.",
        "ddl_file": "sql/ddl/create_SOURCE_REGISTRY.sql",
        "key_columns": ["source_id", "source_name", "system_type", "update_frequency", "data_owner", "ingest_method", "expected_schema_version", "retention_policy", "pii_classification", "active", "created_at_utc", "last_modified_utc", "created_by"]
      },
      {
        "name": "governance.audit_log",
        "purpose": "Governance audit log for events such as source_registration and source_update.",
        "ddl_file": "sql/ddl/create_AUDIT_LOG.sql",
        "key_columns": ["audit_id", "ingest_id", "action", "details", "executed_by", "executed_at_utc"]
      },
      {
        "name": "governance.pipeline_step",
        "purpose": "Registry of all pipeline steps and their definitions.",
        "ddl_file": "sql/ddl/create_PIPELINE_STEP.sql",
        "key_columns": ["step_id", "step_order", "step_name", "step_description", "step_type", "code_snippet", "enabled", "created_at_utc", "last_modified_utc"]
      }
    ],
    "seed_data": [
      {
        "file": "sql/inserts/insert_PIPELINE_STEP.sql",
        "notes": "Inserts STEP_001–STEP_010 into governance.pipeline_step."
      }
    ]
  },
  "configs": {
    "pipeline_settings": {
      "file": "config/pipeline_settings.yml",
      "contents_summary": {
        "schemas": ["governance", "raw", "staging", "validated", "reference"],
        "allowed_system_type": ["CSV", "XLSX", "SQL", "API", "FHIR", "Other"],
        "allowed_update_frequency": ["daily", "weekly", "biweekly", "monthly", "quarterly", "annually", "ad_hoc"],
        "allowed_ingest_method": ["push", "pull", "api", "sftp", "manual"],
        "allowed_pii_classification": ["PHI", "Limited", "NonPHI"]
      }
    },
    "source_params": {
      "file": "config/source_params.yml",
      "usage": "Holds one source definition at a time for onboarding.",
      "fields": ["source_id", "source_name", "system_type", "update_frequency", "data_owner", "ingest_method", "expected_schema_version", "retention_policy", "pii_classification", "active"]
    },
    "directory_structure": {
      "file": "directory_structure.yml",
      "usage": "Template used by create_source_folders() to build folder trees.",
      "zones_example": ["raw/{source_id}/incoming/", "raw/{source_id}/archive/", "staging/{source_id}/incoming/", "staging/{source_id}/archive/", "validated/{source_id}/", "governance/logs/", "governance/qc/", "governance/reports/"]
    }
  },
  "functions": [
    {
      "name": "connect_to_pulse",
      "file": "r/connect_to_pulse.R",
      "category": "db_connection",
      "description": "Connects to Postgres using env vars PULSE_DB, PULSE_HOST, PULSE_USER, PULSE_PW.",
      "calls": ["DBI::dbConnect", "RPostgres::Postgres"],
      "called_by": ["run_pipeline", "tests", "manual_use"]
    },
    {
      "name": "load_pipeline_settings",
      "file": "r/runner.R",
      "category": "config_loader",
      "description": "Loads global pipeline settings and vocab lists from pipeline_settings.yml.",
      "calls": "yaml::read_yaml",
      "called_by": ["run_pipeline", "register_source", "validate_source_entry (indirect)"]
    },
    {
      "name": "get_pipeline_steps",
      "file": "r/runner.R",
      "category": "runner_helper",
      "description": "Fetches enabled steps from governance.pipeline_step and sorts by step_order.",
      "calls": ["DBI::dbReadTable", "dplyr::filter", "dplyr::arrange"],
      "called_by": "run_pipeline"
    },
    {
      "name": "execute_step",
      "file": "r/runner.R",
      "category": "runner_helper",
      "description": "Executes individual steps; special handling for STEP_001, SQL, R, and RMD types.",
      "calls": ["load_source_params", "run_step1_register_source", "do.call", "glue::glue", "DBI::dbExecute", "rmarkdown::render"],
      "called_by": "run_pipeline"
    },
    {
      "name": "run_pipeline",
      "file": "r/runner.R",
      "category": "runner_main",
      "description": "Main pipeline orchestration function for a given ingest_id.",
      "calls": ["connect_to_pulse", "load_pipeline_settings", "get_pipeline_steps", "execute_step"],
      "called_by": ["pulse_launch", "integration_tests", "manual_use"]
    },
    {
      "name": "validate_source_entry",
      "file": "r/utilities/validate_source_entry.R",
      "category": "validation",
      "description": "Validates source candidate list against required fields and allowed vocab.",
      "calls": [],
      "called_by": ["register_source", "unit_tests"]
    },
    {
      "name": "create_source_folders",
      "file": "r/utilities/create_source_folders.R",
      "category": "filesystem",
      "description": "Creates folder tree for source_id using directory_structure.yml.",
      "calls": ["yaml::read_yaml", "fs::dir_create", "normalizePath", "glue::glue"],
      "called_by": "register_source"
    },
    {
      "name": "write_audit_event",
      "file": "r/steps/write_audit_event.R",
      "category": "governance",
      "description": "Writes JSON-encoded audit events to governance.audit_log.",
      "calls": ["uuid::UUIDgenerate", "jsonlite::toJSON", "DBI::dbGetQuery", "DBI::dbExecute"],
      "called_by": ["register_source", "future_steps"]
    },
    {
      "name": "register_source",
      "file": "r/steps/register_source.R",
      "category": "step_logic",
      "description": "Step 1 core logic; insert/update registry, folder creation, audit logging.",
      "calls": ["yaml::read_yaml", "validate_source_entry", "DBI::dbGetQuery", "DBI::dbExecute", "create_source_folders", "write_audit_event"],
      "called_by": ["run_step1_register_source", "unit_tests", "manual_console"]
    },
    {
      "name": "write_pipeline_step",
      "file": "r/utilities/write_pipeline_step.R",
      "category": "governance",
      "description": "Writes pipeline step metadata into governance.pipeline_step.",
      "calls": "DBI::dbExecute",
      "called_by": ["run_step1_register_source", "future_step_wrappers"]
    },
    {
      "name": "run_step1_register_source",
      "file": "r/steps/run_step1_register_source.R",
      "category": "step_wrapper",
      "description": "Wrapper for STEP_001 that calls register_source() and writes pipeline_step entry.",
      "calls": ["register_source", "write_pipeline_step"],
      "called_by": ["execute_step", "unit_tests"]
    },
    {
      "name": "load_source_params",
      "file": "r/utilities/load_source_params.R",
      "category": "config_loader",
      "description": "Loads YAML source parameters from config/source_params.yml.",
      "calls": "yaml::read_yaml",
      "called_by": ["execute_step", "integration_tests", "manual_use"]
    },
    {
      "name": "pulse_launch",
      "file": "pulse-launch.R",
      "category": "entrypoint",
      "description": "High-level launcher for pipeline runs; can write source_params.yml and then call run_pipeline().",
      "calls": ["yaml::write_yaml", "run_pipeline"],
      "called_by": ["r/scripts/1_onboard_new_source.R", "integration_tests", "future_CLI"]
    }
  ],
  "scripts": [
    {
      "path": "r/scripts/1_onboard_new_source.R",
      "purpose": "Human-friendly onboarding script guiding user inputs and calling pulse_launch()."
    },
    {
      "path": "pulse-init-all.R",
      "purpose": "Project bootstrap script that loads R scripts and packages."
    }
  ],
  "tests": {
    "unit": "tests/testthat/test_step1_register_source.R",
    "integration": "tests/testthat/test_step1_integration.R",
    "status": "all_pass"
  },
  "step1_status": {
    "ddl_created": true,
    "functions_implemented": true,
    "folder_creation_working": true,
    "audit_logging_working": true,
    "unit_tests_pass": true,
    "integration_tests_pass": true,
    "runner_integration_complete": true
  }
}
